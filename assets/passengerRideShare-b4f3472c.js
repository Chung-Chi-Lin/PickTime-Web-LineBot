import{S as h,_ as R}from"./check-2973d6cc.js";import{_ as C,m as w,r as M,o as d,c as l,a as y,w as B,b as t,d as _,t as c,f as b,v as F,g as f,F as v,h as k,i as Y,n as S,j as $}from"./index-4f2f1b3f.js";import{i as A,_ as E,a as N}from"./empty-9385de3f.js";const P={components:{DatePicker:A},data(){return{selectedDate:this.$moment().toDate(),startDate:this.$moment().toDate(),endDate:this.$moment().add(1,"days").toDate(),isRange:!1,reverseType:!0,formattedFareData:[],fareData:[],fareCountData:[],formattedDriveData:[],driveData:[],notDriveData:[],formattedPassengerData:[],takeRideData:[],notTakeRideData:[],fareCountTotal:"",amount:null,isLoading:!1,filteredType:"當月車費",category:["當月車費","上月車費","搭乘登記"]}},methods:{async getFareData(){const{userType:s,email:e}=this.userInfo,{token:n}=this.$store.state,i={headers:{Authorization:`Bearer ${n}`}};try{const a=await this.$http.post("https://todolist-sql.onrender.com/fare/get_fare",{email:e},i),{found:r,fareData:u}=a.data;r&&(this.fareData=u.fare,this.fareCountData=u.fareCount,this.updateFormattedFareDate(this.filteredType))}catch(a){console.error("Error:",a)}},formatFareData(s,e){return s.filter(e).map(({id:n,line_user_id:i,...a})=>({...a,update_time:this.$moment(a.update_time).format("YYYY-MM-DD")}))},updateFormattedFareDate(s){const e=this.$moment().startOf("month"),n=this.$moment().subtract(1,"month").startOf("month"),i=this.$moment().subtract(1,"month").endOf("month");let a;s==="當月車費"?a=r=>this.$moment(r.update_time).isSameOrAfter(e):s==="上月車費"&&(a=r=>this.$moment(r.update_time).isBetween(n,i,null,"[]")),this.formattedFareData=[...this.formatFareData(this.fareData,a),...this.formatFareData(this.fareCountData,a)],this.calculateTotalFareCount()},calculateTotalFareCount(){const s=this.formattedFareData.reduce((e,n)=>n.user_fare_count?e+n.user_fare_count:e,0);s<0?this.fareCountTotal=`下月扣除 ${Math.abs(s)} 元`:s>=0?this.fareCountTotal=`下月需補 ${s} 元`:this.fareCountTotal="尚無紀錄"},async countFareData(){const{value:s}=await h.fire({title:"需付搭乘費計算",text:"請提供金額進行下月實付計算",input:"number",inputPlaceholder:"輸入您的金額",inputAttributes:{min:1},showCancelButton:!0,confirmButtonText:"確認",cancelButtonText:"取消"});if(s)if(!Number.isNaN(s)&&s>0){const e=this.formattedFareData.reduce((i,a)=>a.user_fare_count?i+a.user_fare_count:i,0),n=Number(s)+e;h.fire(`本次需付: ${n} 元`)}else h.fire("錯誤","請輸入有效的金額","error")},async getDriverData(s){const{token:e}=this.$store.state,n={headers:{Authorization:`Bearer ${e}`},params:{month:"current"}};try{const i=await this.$http.get("https://todolist-sql.onrender.com/driver_dates",n),{drive:a,notDrive:r}=i.data;i.data&&(console.log(a),console.log(r),this.driveData=a,this.notDriveData=r,await this.formatDriveData())}catch(i){console.error("Error:",i)}},formatDriveData(){this.formattedDriveData=[],!this.driveData||this.driveData.length===0?this.formattedDriveData.push({start_date:null,end_date:null,note:"",pass_limit:null}):this.driveData.forEach(s=>{const e=this.formatDate(s.start_date),n=this.formatDate(s.end_date);this.formattedDriveData.push({start_date:e,end_date:n,note:s.note,pass_limit:s.pass_limit})}),this.formatNotDriveData()},formatNotDriveData(){Array.isArray(this.notDriveData)&&this.notDriveData.forEach(s=>{const e=this.formatDate(s.start_date),n=this.formatDate(s.end_date);e===n?this.formattedDriveData.push({start_date:e,end_date:null,note:s.note}):this.formattedDriveData.push({start_date:e,end_date:n,note:s.note})})},async getPassengerData(s){const{token:e}=this.$store.state,n={headers:{Authorization:`Bearer ${e}`},params:{month:"current"}};try{const i=await this.$http.get("https://todolist-sql.onrender.com/passenger_dates",n),{takeRide:a,notTakeRide:r}=i.data;i.data&&(this.takeRideData=a,this.notTakeRideData=r,await this.formatTakeRideData())}catch(i){console.error("Error:",i)}},formatTakeRideData(){this.formattedPassengerData=[],!this.takeRideData||this.takeRideData.length===0?this.formattedPassengerData.push({id:null,start_date:null,end_date:null,note:""}):this.takeRideData.forEach(s=>{const e=this.formatDate(s.start_date),n=this.formatDate(s.end_date);this.formattedPassengerData.push({id:s.id,start_date:e,end_date:n,note:s.note})}),this.formatNotTakeRideData()},formatNotTakeRideData(){Array.isArray(this.notTakeRideData)&&this.notTakeRideData.forEach(s=>{const e=this.formatDate(s.start_date),n=this.formatDate(s.end_date);e===n?this.formattedPassengerData.push({id:s.id,start_date:e,end_date:null,note:s.note}):this.formattedPassengerData.push({id:s.id,start_date:e,end_date:n,note:s.note})})},formatDate(s){const e=new Date(s),n=e.getFullYear(),i=(e.getMonth()+1).toString().padStart(2,"0"),a=e.getDate().toString().padStart(2,"0");return`${n}-${i}-${a}`},async reserveDate(){if(this.$moment(this.startDate).format("YYYY-MM-DD")===this.$moment(this.endDate).format("YYYY-MM-DD")){h.fire("錯誤","同日請選擇單日選項","warning");return}let s="";if(this.isRange){const n=this.$moment(this.startDate).format("YYYY/MM/DD"),i=this.$moment(this.endDate).format("YYYY/MM/DD");s=`您選擇的區間是：<br>${n} 至 ${i}<br>確認預約嗎？`}else s=`您選擇的日期是：${this.$moment(this.selectedDate).format("YYYY/MM/DD")}。確認預約嗎？`;if((await h.fire({title:"確認預約",html:s,icon:"question",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"確定",cancelButtonText:"取消"})).isConfirmed){const n=await h.fire({title:"補充備註",input:"text",inputPlaceholder:"如果需要，請在這裡輸入備註...",showCancelButton:!0,confirmButtonText:"確定",cancelButtonText:"不用"});if(n.isConfirmed){const{token:i}=this.$store.state;let a=n.value?n.value:null;const r={headers:{Authorization:`Bearer ${i}`}},u=this.$moment(this.isRange?this.startDate:this.selectedDate).format("YYYY-MM-DD"),p=this.isRange?this.$moment(this.endDate).format("YYYY-MM-DD"):u,g={start_date:u,end_date:p,reverse_type:this.reverseType?1:0,note:a||null};try{(await this.$http.post("https://todolist-sql.onrender.com/reserve",g,r)).data&&(h.fire("預約成功！","您的預約已成功提交。","success"),await this.getPassengerData())}catch(D){console.error("預約錯誤:",D),h.fire("錯誤","預約過程中發生錯誤","error")}}}},async delTakeRide(s){if((await h.fire({title:"確認刪除",text:"您確定要刪除這條預約記錄嗎？",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"刪除！",cancelButtonText:"取消"})).isConfirmed){const{token:n}=this.$store.state,i={headers:{Authorization:`Bearer ${n}`}};try{(await this.$http.delete(`https://todolist-sql.onrender.com/passenger_dates/${s}`,i)).data&&(h.fire("已刪除！","您的預約記錄已被刪除。","success"),this.getPassengerData())}catch(a){console.error("刪除錯誤:",a),h.fire("錯誤","刪除過程中發生錯誤","error")}}},handleChangeCategory(s){this.filteredType=s},isCurrentMonth(s){const e=this.$moment().format("YYYY-MM");return s.startsWith(e)},async addAmount(){const{userType:s,email:e}=this.userInfo,{token:n}=this.$store.state;this.isLoading=!0;const i={headers:{Authorization:`Bearer ${n}`}};if(s==="乘客"&&(!this.amount||this.amount<=0)){this.isLoading=!1,h.fire("錯誤","請輸入有效的金額","error");return}const a={email:e,userFare:this.amount};try{const r=await this.$http.post("https://todolist-sql.onrender.com/fare/add_fare",a,i),{message:u}=r.data;u&&(h.fire("成功",u,"success"),this.getFareData())}catch(r){h.fire("錯誤","無法更新匯款紀錄","error"),console.error("Error:",r)}this.isLoading=!1},signOut(){this.$store.dispatch("clearAuthData"),localStorage.removeItem("token");const s="https://todolist-sql.onrender.com/users/sign_out";this.$http.post(s).then(e=>{h.fire({title:"登出成功",text:e.data.message,icon:"success",confirmButtonText:"了解"})}).catch(e=>{h.fire({title:"登出失敗",text:e.response.data.message,icon:"error",confirmButtonText:"了解"})}),this.$router.push("/"),this.isLoading=!1}},watch:{filteredType(s){s&&(this.filteredType==="當月車費"||this.filteredType==="上月車費")&&this.updateFormattedFareDate(s)}},computed:{...w({userInfo:"getUserInfo"}),disabledDates(){const s=new Set;return this.notDriveData.forEach(e=>{const n=this.$moment(e.start_date),i=this.$moment(e.end_date);if(n.isBefore(i,"day")){let a=n;for(;a.isSameOrBefore(i);)s.add(a.format("YYYY-MM-DD")),a.add(1,"days")}else s.add(n.format("YYYY-MM-DD"))}),this.startDate&&s.add(this.$moment(this.startDate).format("YYYY-MM-DD")),this.endDate&&s.add(this.$moment(this.endDate).format("YYYY-MM-DD")),e=>{const n=this.$moment(e).format("YYYY-MM-DD");return s.has(n)||!this.isCurrentMonth(n)}}},mounted(){this.getFareData(),this.getDriverData(),this.getPassengerData()}},O={class:"todo-bg pt-1"},q=t("div",{class:"loadingio-spinner-bean-eater-iylmkqp50l"},[t("div",{class:"ldio-t0eby9sr4hr"},[t("div",null,[t("div"),t("div"),t("div")]),t("div",null,[t("div"),t("div"),t("div")])])],-1),I={class:"d-none d-md-block"},U={class:"m-4 d-flex justify-content-between"},j={class:"fw-bold h2 ps-3"},z=t("img",{src:R,alt:"checkbox",style:{height:"55px"}},null,-1),L={class:"d-flex align-items-center"},V={class:"h3 pe-3"},G={class:"m-3 d-flex justify-content-between d-md-none"},H={class:"f-Baloo fw-bold pt-2 h5"},W=t("img",{src:E,alt:"checkbox"},null,-1),J={class:"d-flex align-items-center"},K={class:"container pb-5"},Q={key:0,class:"input-group mb-3"},X=t("span",{class:"input-group-text fs-4"},"$",-1),Z={class:"input-group-text px-1 py-1 bg-white border-0",for:"todo"},tt=t("i",{class:"bi bi-plus-square-fill fs-5"},null,-1),et=[tt],st={key:1,class:"row row-cols-1 d-flex justify-content-center my-5"},at=t("h3",{class:"col text-center"},"目前尚無待辦資料",-1),ot=t("img",{class:"img-fluid col-4",src:N,alt:""},null,-1),nt=[at,ot],rt={class:"card"},it={class:"card-header bg-transparent text-center"},dt={class:"nav row mt-2"},lt=["onClick"],ct={key:0,class:"card-body"},ht=t("h5",{class:"d-inline mb-3 me-3"},"搭乘選項:",-1),ut={class:"form-check form-check-inline mb-3"},mt=t("label",{class:"form-check-label",for:"inlineRadio3"},"搭乘",-1),ft={class:"form-check form-check-inline mb-3"},_t=t("label",{class:"form-check-label",for:"inlineRadio4"},"不搭乘",-1),pt=t("h5",{class:"d-inline mb-3 me-3"},"日期範圍:",-1),Dt={class:"form-check form-check-inline mb-3"},bt=t("label",{class:"form-check-label",for:"inlineRadio2"},"單日",-1),gt={class:"form-check form-check-inline mb-3"},yt=t("label",{class:"form-check-label",for:"inlineRadio1"},"日期區間",-1),vt={key:0},kt=t("h5",{class:"mb-3"},"選擇單日",-1),Yt={key:1},Tt=t("h5",{class:"mb-3"},"選擇搭乘區間",-1),Mt={class:"d-flex"},xt=t("div",{class:"px-3"},"～",-1),Rt={class:"bg-transparent d-flex justify-content-end mt-3"},Ct=t("ul",{class:"list-group border-top my-4 border-3 border-secondary list-group-flush"},null,-1),wt={class:"ms-1 mb-0"},Bt={class:"badge bg-success p-2"},Ft={key:0,class:"list-group-item text-start border-bottom"},St={class:"d-flex justify-content-end m-0 p-0"},$t=["onClick"],At=t("i",{class:"bi bi-x-square-fill fs-4",style:{color:"#ff0000"}},null,-1),Et=[At],Nt={class:"mb-3"},Pt={class:"form-check-label d-block mb-2"},Ot={key:0},qt={key:1},It={class:"text-end d-block"},Ut={key:0},jt={key:1},zt={key:2,class:"list-group border-top my-4 border-3 border-secondary list-group-flush"},Lt={class:"mt-4 ms-1 mb-0"},Vt={class:"badge bg-primary p-2"},Gt={key:3},Ht={class:"list-group-item text-start border-bottom"},Wt={class:"mb-3"},Jt={key:0,class:"text-end d-block mb-3"},Kt={class:"form-check-label d-block mb-2"},Qt={key:0},Xt={key:1},Zt={class:"text-end d-block"},te={key:0},ee={key:1},se={key:1,class:"card-body"},ae={class:"list-group-item text-start border-bottom"},oe={class:"form-check-label d-block"},ne={key:0},re={key:1},ie={class:"text-end d-block"},de={class:"list-group border-top border-3 border-secondary list-group-flush"},le={class:"list-group-item fs-5 d-flex justify-content-between mt-2"},ce={class:"form-check-label ms-auto mt-2"},he={key:2,class:"card-footer bg-transparent d-flex justify-content-between pt-3"},ue={class:"pt-3"},me={class:"fs-5"};function fe(s,e,n,i,a,r){var g,D,T;const u=M("loading"),p=M("DatePicker");return d(),l("div",O,[y(u,{active:a.isLoading},{default:B(()=>[q]),_:1},8,["active"]),t("div",I,[t("header",U,[t("h1",j,[z,_(" "+c((((g=s.userInfo)==null?void 0:g.userName)??"")+" 共乘服務"),1)]),t("div",L,[t("h2",V,c(((D=s.userInfo)==null?void 0:D.userName)??""),1),t("button",{class:"btn btn-lg btn-h",onClick:e[0]||(e[0]=(...o)=>r.signOut&&r.signOut(...o))},"登出")])])]),t("header",G,[t("h1",H,[W,_(" "+c((((T=s.userInfo)==null?void 0:T.userName)??"")+" 共乘服務"),1)]),t("div",J,[t("button",{class:"btn btn-sm btn-h",onClick:e[1]||(e[1]=(...o)=>r.signOut&&r.signOut(...o))},"登出")])]),t("main",K,[a.filteredType==="當月車費"&&s.userInfo.userType==="乘客"?(d(),l("div",Q,[X,b(t("input",{"onUpdate:modelValue":e[2]||(e[2]=o=>a.amount=o),type:"number",onkeyup:"value=value.replace(/D+/g, 0)",class:"form-control border-0 py-2",placeholder:"輸入匯款金額",id:"numberInput"},null,512),[[F,a.amount,void 0,{number:!0}]]),t("label",Z,[t("button",{class:"btn btn-sm",onClick:e[3]||(e[3]=(...o)=>r.addAmount&&r.addAmount(...o)),type:"button",id:"button-addon2"},et)])])):f("",!0),s.userInfo.userName?f("",!0):(d(),l("div",st,nt)),t("div",rt,[t("div",it,[t("nav",dt,[(d(!0),l(v,null,k(a.category,(o,m)=>(d(),l("a",{class:S(["text-sm-center text-decoration-none col-4 py-2",{tab:a.filteredType===o}]),key:"category"+m,"aria-current":"page",href:"#",onClick:$(x=>r.handleChangeCategory(o),["prevent"])},c(o),11,lt))),128))])]),a.filteredType==="搭乘登記"?(d(),l("div",ct,[t("div",null,[ht,t("div",ut,[b(t("input",{"onUpdate:modelValue":e[4]||(e[4]=o=>a.reverseType=o),class:"form-check-input",type:"radio",name:"inlineRadioOptions2",id:"inlineRadio3",value:"true"},null,512),[[Y,a.reverseType]]),mt]),t("div",ft,[b(t("input",{"onUpdate:modelValue":e[5]||(e[5]=o=>a.reverseType=o),class:"form-check-input",type:"radio",name:"inlineRadioOptions2",id:"inlineRadio4",value:!1},null,512),[[Y,a.reverseType]]),_t])]),t("div",null,[pt,t("div",Dt,[b(t("input",{"onUpdate:modelValue":e[6]||(e[6]=o=>a.isRange=o),class:"form-check-input",type:"radio",name:"inlineRadioOptions",id:"inlineRadio2",value:!1},null,512),[[Y,a.isRange]]),bt]),t("div",gt,[b(t("input",{"onUpdate:modelValue":e[7]||(e[7]=o=>a.isRange=o),class:"form-check-input",type:"radio",name:"inlineRadioOptions",id:"inlineRadio1",value:"true"},null,512),[[Y,a.isRange]]),yt])]),a.isRange?(d(),l("div",Yt,[Tt,t("div",Mt,[y(p,{name:"startDate",type:"day",format:"YYYY/MM/DD",value:a.startDate,"onUpdate:value":e[9]||(e[9]=o=>a.startDate=o),"disabled-date":r.disabledDates},null,8,["value","disabled-date"]),xt,y(p,{name:"endDate",type:"day",format:"YYYY/MM/DD",value:a.endDate,"onUpdate:value":e[10]||(e[10]=o=>a.endDate=o),"disabled-date":r.disabledDates},null,8,["value","disabled-date"])])])):(d(),l("div",vt,[kt,y(p,{name:"singleDate",type:"day",format:"YYYY/MM/DD",value:a.selectedDate,"onUpdate:value":e[8]||(e[8]=o=>a.selectedDate=o),"disabled-date":r.disabledDates},null,8,["value","disabled-date"])])),t("div",Rt,[t("button",{type:"button",class:"btn btn-info border-0 btn-h p-2 px-3",onClick:e[11]||(e[11]=(...o)=>r.reserveDate&&r.reserveDate(...o))},"預約")]),Ct,t("h3",wt,[t("span",Bt,c(a.takeRideData?"您的搭乘表":"尚無預約"),1)]),t("div",null,[(d(!0),l(v,null,k(a.formattedPassengerData,(o,m)=>(d(),l("ul",{class:"list-group list-group-flush",key:o.id},[o.id!==null?(d(),l("li",Ft,[t("div",St,[t("button",{class:"btn btn",onClick:x=>r.delTakeRide(o.id),type:"button",id:"button-addon2"},Et,8,$t)]),t("div",Nt,[t("label",Pt,[m===0?(d(),l("span",Ot,"*本月搭乘日＞ ")):(d(),l("span",qt,"不搭車日＞ ")),_(" 備註:"+c(o.note??"無備註"),1)]),t("label",It,[m===0?(d(),l("span",Ut,"搭車")):(d(),l("span",jt,"不搭車")),_("日期:"+c(o.start_date)+" "+c(o.end_date?`～ ${o.end_date}`:""),1)])])])):f("",!0)]))),128))]),a.takeRideData?f("",!0):(d(),l("ul",zt)),t("h3",Lt,[t("span",Vt,c(a.driveData?"司機表":"司機尚無開放預約"),1)]),a.driveData?(d(),l("div",Gt,[(d(!0),l(v,null,k(a.formattedDriveData,(o,m)=>(d(),l("ul",{class:"list-group list-group-flush",key:o.id},[t("li",Ht,[t("div",Wt,[o.pass_limit?(d(),l("label",Jt,[t("h5",null,c(o.pass_limit?`乘客限:${o.pass_limit}位`:""),1)])):f("",!0),t("label",Kt,[m===0&&o.pass_limit?(d(),l("span",Qt,"*本月開車日＞ ")):(d(),l("span",Xt,"不開車日＞ ")),_(" 備註:"+c(o.note??"無備註"),1)]),t("label",Zt,[m===0?(d(),l("span",te,"開車")):(d(),l("span",ee,"不開車")),_("日期:"+c(o.start_date)+" "+c(o.end_date?`～ ${o.end_date}`:""),1)])])])]))),128))])):f("",!0)])):f("",!0),a.filteredType!=="搭乘登記"&&a.filteredType!=="開車登記"?(d(),l("div",se,[(d(!0),l(v,null,k(a.formattedFareData,(o,m)=>(d(),l("ul",{class:"list-group list-group-flush",key:o.id},[t("li",ae,[t("div",null,[t("label",oe,[m===0?(d(),l("span",ne,"匯款＞ ")):(d(),l("span",re,"紀錄＞ ")),_(" 費用:"+c(o.user_fare??o.user_fare_count)+c(o.user_remark?` , 原因:${o.user_remark}`:""),1)]),t("label",ie," 紀錄日期:"+c(o.update_time),1)])])]))),128)),t("ul",de,[t("li",le,[t("label",ce,c(a.fareCountTotal),1)])])])):f("",!0),a.filteredType!=="搭乘登記"&&a.filteredType!=="開車登記"?(d(),l("div",he,[t("p",ue,[t("span",me,c(a.formattedFareData.length>0?a.formattedFareData.length-1:0),1),_(" 則車費紀錄")]),t("button",{type:"button",class:"btn btn-info my-2 border-0 btn-h",onClick:e[12]||(e[12]=(...o)=>r.countFareData&&r.countFareData(...o))},"當前紀錄計算")])):f("",!0)])])])}const be=C(P,[["render",fe]]);export{be as default};
